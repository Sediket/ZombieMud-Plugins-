<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, June 30, 2007, 10:48  -->
<!-- MuClient version 4.13 -->

<!-- Plugin "Chat_Redirector" generated by Plugin Wizard -->

<!--
Edit plugin and change "chat_world" variable to be the name of the 
world you want chats to go to.
-->

<muclient>
<plugin
   name="Channel_Redirector"
   author="Nick Gammon"
   id="cb84a526b476f69f403517da"
   language="Lua"
   purpose="Redirects chat messages to another world"
   date_written="2007-06-30 10:45:35"
   requires="4.08"
   version="1.0"
   >
<description trim="y">
<![CDATA[
Redirects chats to the specified world.

Add or modify "chat" triggers to capture different sorts of message.

Change the variable "chat_world" to be the name of the world chats are to go to.
]]>
</description>

</plugin>

<!--  Triggers  -->

<triggers>

    <trigger
    enabled="y"
    match="^(?:\[|\{|\<)(\w+)(?:\]|\}|\>): .*$"
    regexp="y"
    omit_from_output="y"
    sequence="100"
    script="redirect"
    ></trigger>

    <trigger
    enabled="y"
    match="^[a-zA-Z ]+ (?:\[|\{|\<)(\w+)(?:\]|\}|\>): .*$"
    regexp="y"
    omit_from_output="y"
    sequence="100"
    script="redirect"
    ></trigger>

    <trigger
    enabled="y"
    match="^\w*\s*\d*\s*\d+:\d+ (?:\w*|\w+ \w+ \w+|\w+ \(\w+\))\s*(?:\[|\{|\<)(\w+)(?:\]|\}|\>): .*$"
    regexp="y"
    omit_from_output="y"
    sequence="100"
    script="last_redirect"
    ></trigger>



</triggers>

<!--  Script  -->


<script>
<![CDATA[
chat_world = "channels"

--log channels
logit = 1

-- Logs directory relative to MushClient install:
-- Example: "ZombieMush\\Logs\\"
log_directory = "ZombieMush\\Logs\\"

-- Example of relative location:
-- C:\Program Files (x86)\MUSHclient\worlds\ZombieMush\Logs


if logit == 1 then
  --time zone offset form zombiemud server in seconds
  zombie_time_zone_offset = 21600

  -- Prepend with full directory structure
  log_directory = GetInfo (57) .. log_directory
  local first_time = true

  --Create the log directory:
  os.execute ('mkdir "'..log_directory ..'"')

  --Turn \ into / for lua file reading
  log_directory = log_directory:gsub("\\","/")
  log_directory = log_directory .. os.date("%y_%b_")
end

function redirect (name, line, wildcards, styles)
  line = os.date("%c ") .. line 

  -- try to find "chat" world
  local w = GetWorld (chat_world)  -- get "chat" world

  -- if not found, try to open it
  if first_time and not w then
    local filename = GetInfo (67) .. chat_world .. ".mcl"
    Open (filename)
    w = GetWorld (chat_world)  -- try again
    if not w then
      ColourNote ("white", "red", "Can't open chat world file: " .. filename)
      first_time = false  -- don't repeatedly show failure message
    end -- can't find world 
  end -- can't find world first time around

  if w then  -- if present
    if logit == 1 then
      f = io.open (log_directory .. "active_"..wildcards[1]..".txt", "a") --> handle to new file
      f:write (line.."\n") -- write to it
      f:close ()  -- close that file now
    end

    for _, v in ipairs (styles) do
      w:ColourTell (RGBColourToName (v.textcolour), 
                    RGBColourToName (v.backcolour), 
                    v.text)  
    end -- for each style run
    w:Note ("")  -- wrap up line

  end -- world found

end -- function redirect 

function last_redirect (name, line, wildcards, styles)
    -- try to find "chat" world
    local w = GetWorld (chat_world)  -- get "chat" world
  
    -- if not found, try to open it
    if first_time and not w then
      local filename = GetInfo (67) .. chat_world .. ".mcl"
      Open (filename)
      w = GetWorld (chat_world)  -- try again
      if not w then
        ColourNote ("white", "red", "Can't open chat world file: " .. filename)
        first_time = false  -- don't repeatedly show failure message
      end -- can't find world 
    end -- can't find world first time around


    if w then  -- if present
      if logit == 1 then      
        a = io.open (log_directory.."last_"..wildcards[1]..".txt", "a") --> handle to new file
        f = io.input(log_directory.."last_"..wildcards[1]..".txt")
        all = f:read("*a")
          f:close()

          if not line:find("^%w+%s%d+%s.*$") then
              now = os.time()
              line_to_write = os.date("%b %d",now+zombie_time_zone_offset) .. " " .. line --adjust for EET time
          else
              line_to_write = line
          end
        if all ==nil then
          a:write (line_to_write.."\n") -- write to it     
        elseif not all:find(line_to_write,0,true)  then --string,starting postition, plaintext
              a:write (line_to_write.."\n") -- write to it
        end
        a:close ()  -- close that file now
      end -- end logit if

      for _, v in ipairs (styles) do
        w:ColourTell (RGBColourToName (v.textcolour), 
                      RGBColourToName (v.backcolour), 
                      v.text)  
      end -- for each style run
      w:Note ("")  -- wrap up line
  
    end -- world found
  
  end -- function redirect 


]]>
</script>


</muclient>